"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getAll = exports.deleteOne = exports.updateMany = exports.updateOneByQuery = exports.updateOneById = exports.count = exports.getPaging = exports.findByPipeline = exports.findByQuery = exports.findById = exports.create = exports.aggregate = exports.withTransaction = void 0;
const tslib_1 = require("tslib");
const mongoose_1 = tslib_1.__importDefault(require("mongoose"));
const base_response_1 = require("../error/base.response");
///TRANSACTION
async function withTransaction(callback) {
    try {
        let result;
        const session = await mongoose_1.default.startSession();
        await session.withTransaction(async () => {
            result = await callback(session);
        });
        await session.endSession();
        return result;
    }
    catch (e) {
        console.log(e);
        throw base_response_1.BaseResponse.UnknownError(e);
    }
}
exports.withTransaction = withTransaction;
///AGGREGATE
async function aggregate(model, pipeline) {
    try {
        return await model.aggregate(pipeline);
    }
    catch (e) {
        console.log(e);
        throw base_response_1.BaseResponse.UnknownError(e);
    }
}
exports.aggregate = aggregate;
///CREATE
async function create(model, data, options) {
    try {
        return (await model.create([data], options)).shift(); //shu joyda shift return yoq ed
    }
    catch (e) {
        console.log(e);
        throw e;
    }
}
exports.create = create;
///FIND BY ID
async function findById(model, _id, project = {}, options) {
    try {
        const query = { _id, isDeleted: false };
        const projection = { __v: 0, isDeleted: 0, ...project };
        return await model.findOne(query, projection, options);
    }
    catch (e) {
        console.log(e);
        throw base_response_1.BaseResponse.UnknownError(e);
    }
}
exports.findById = findById;
///FIND BY QUERY
async function findByQuery(model, query, project = {}, options) {
    try {
        const projection = { __v: 0, isDeleted: 0, ...project };
        return await model.findOne(query, projection, options);
    }
    catch (e) {
        console.log(e);
        throw base_response_1.BaseResponse.UnknownError(e);
    }
}
exports.findByQuery = findByQuery;
///FIND BY PIPELINE
async function findByPipeline(model, _id, pipeline = [], options) {
    try {
        const baseQuery = {
            isDeleted: false,
            _id,
        };
        const $match = {
            $match: baseQuery
        };
        const $pipeline = [$match, ...pipeline];
        const data = await model.aggregate($pipeline, options);
        return data[0];
    }
    catch (e) {
        console.log(e);
        throw base_response_1.BaseResponse.UnknownError(e);
    }
}
exports.findByPipeline = findByPipeline;
///FIND BY PAGING
async function getPaging(model, dto, query, sort, pipeline = []) {
    try {
        const baseQuery = {
            isDeleted: false,
            ...query
        };
        const $match = {
            $match: baseQuery
        };
        let $sort = {
            $sort: {
                _id: 1
            }
        };
        if (sort) {
            $sort.$sort = sort;
        }
        const { page, limit } = dto;
        const total = await model.countDocuments(baseQuery);
        const $pipeline = [$match, $sort, ...pipeline];
        const data = await model
            .aggregate($pipeline)
            .skip(limit * (page - 1))
            .limit(limit)
            .project({ __v: 0, isDeleted: 0 });
        return {
            total,
            data
        };
    }
    catch (e) {
        console.log(e);
        throw base_response_1.BaseResponse.UnknownError(e);
    }
}
exports.getPaging = getPaging;
///COUNT
async function count(model, query) {
    try {
        const baseQuery = {
            isDeleted: false,
            ...query,
        };
        return await model.countDocuments(baseQuery);
    }
    catch (e) {
        console.log(e);
        throw base_response_1.BaseResponse.UnknownError(e);
    }
}
exports.count = count;
///UPDATE ONE BY ID
async function updateOneById(model, _id, data, options) {
    try {
        return await model.updateOne({ _id }, data, options);
    }
    catch (e) {
        console.log(e);
        throw e;
    }
}
exports.updateOneById = updateOneById;
///UPDATE ONE BY QUERY
async function updateOneByQuery(model, query, data, options) {
    try {
        await model.findOneAndUpdate(query, data, { ...options, new: true });
        return;
    }
    catch (e) {
        console.log(e);
        throw e;
    }
}
exports.updateOneByQuery = updateOneByQuery;
///UPDATE MANY BY QUERY
async function updateMany(model, query, data, options) {
    try {
        await model.updateMany(query, data, options);
        return;
    }
    catch (e) {
        console.log(e);
        throw base_response_1.BaseResponse.UnknownError(e);
    }
}
exports.updateMany = updateMany;
///DELETE
async function deleteOne(model, query) {
    try {
        return await model.deleteOne(query);
    }
    catch (e) {
        console.log(e);
        throw base_response_1.BaseResponse.UnknownError(e);
    }
}
exports.deleteOne = deleteOne;
///GET ALL /* custom */
async function getAll(model, query = {}, project = {}) {
    try {
        const Query = { isDeleted: false, ...query };
        const projection = { __v: 0, isDeleted: 0, ...project };
        return await model.find(Query, projection);
    }
    catch (e) {
        console.log(e);
        throw base_response_1.BaseResponse.UnknownError(e);
    }
}
exports.getAll = getAll;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvbW1vbi9zZXJ2aWNlL2Jhc2Uuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQ0EsZ0VBQWlGO0FBRWpGLDBEQUFzRDtBQUd0RCxjQUFjO0FBQ1AsS0FBSyxVQUFVLGVBQWUsQ0FBQyxRQUFRO0lBQzFDLElBQUk7UUFDQSxJQUFJLE1BQU0sQ0FBQztRQUNYLE1BQU0sT0FBTyxHQUFHLE1BQU0sa0JBQVEsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUU5QyxNQUFNLE9BQU8sQ0FBQyxlQUFlLENBQUMsS0FBSyxJQUFJLEVBQUU7WUFDckMsTUFBTSxHQUFHLE1BQU0sUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBQ3BDLENBQUMsQ0FBQyxDQUFBO1FBRUYsTUFBTSxPQUFPLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDM0IsT0FBTyxNQUFNLENBQUM7S0FDakI7SUFDRCxPQUFPLENBQUMsRUFBRTtRQUNOLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFDZCxNQUFNLDRCQUFZLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFBO0tBQ3JDO0FBQ0wsQ0FBQztBQWhCRCwwQ0FnQkM7QUFFRCxZQUFZO0FBQ0wsS0FBSyxVQUFVLFNBQVMsQ0FBSSxLQUErQixFQUFFLFFBQWE7SUFDN0UsSUFBSTtRQUNBLE9BQU8sTUFBTSxLQUFLLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFBO0tBQ3pDO0lBQUMsT0FBTyxDQUFDLEVBQUU7UUFDUixPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQ2QsTUFBTSw0QkFBWSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQTtLQUNyQztBQUNMLENBQUM7QUFQRCw4QkFPQztBQUVELFNBQVM7QUFDRixLQUFLLFVBQVUsTUFBTSxDQUFJLEtBQStCLEVBQUUsSUFBSSxFQUFFLE9BQXFCO0lBQ3hGLElBQUk7UUFDQSxPQUFPLENBQUMsTUFBTSxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFBLCtCQUErQjtLQUN2RjtJQUFDLE9BQU8sQ0FBQyxFQUFFO1FBQ1IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUNkLE1BQU0sQ0FBQyxDQUFBO0tBQ1Y7QUFDTCxDQUFDO0FBUEQsd0JBT0M7QUFFRCxhQUFhO0FBQ04sS0FBSyxVQUFVLFFBQVEsQ0FBSSxLQUErQixFQUFFLEdBQVcsRUFBRSxPQUFPLEdBQUcsRUFBRSxFQUFFLE9BQXNCO0lBQ2hILElBQUk7UUFDQSxNQUFNLEtBQUssR0FBRyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLENBQUM7UUFDeEMsTUFBTSxVQUFVLEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FBQyxFQUFFLFNBQVMsRUFBRSxDQUFDLEVBQUUsR0FBRyxPQUFPLEVBQUUsQ0FBQTtRQUN2RCxPQUFPLE1BQU0sS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsVUFBVSxFQUFFLE9BQU8sQ0FBQyxDQUFBO0tBQ3pEO0lBQUMsT0FBTyxDQUFDLEVBQUU7UUFDUixPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQ2QsTUFBTSw0QkFBWSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQTtLQUNyQztBQUNMLENBQUM7QUFURCw0QkFTQztBQUVELGdCQUFnQjtBQUNULEtBQUssVUFBVSxXQUFXLENBQUksS0FBK0IsRUFBRSxLQUFLLEVBQUUsT0FBTyxHQUFHLEVBQUUsRUFBRSxPQUFzQjtJQUM3RyxJQUFJO1FBQ0EsTUFBTSxVQUFVLEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FBQyxFQUFFLFNBQVMsRUFBRSxDQUFDLEVBQUUsR0FBRyxPQUFPLEVBQUUsQ0FBQTtRQUN2RCxPQUFPLE1BQU0sS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsVUFBVSxFQUFFLE9BQU8sQ0FBQyxDQUFBO0tBQ3pEO0lBQUMsT0FBTyxDQUFDLEVBQUU7UUFDUixPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQ2QsTUFBTSw0QkFBWSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQTtLQUNyQztBQUNMLENBQUM7QUFSRCxrQ0FRQztBQUVELG1CQUFtQjtBQUNaLEtBQUssVUFBVSxjQUFjLENBQUksS0FBK0IsRUFBRSxHQUFXLEVBQUUsV0FBa0IsRUFBRSxFQUFFLE9BQTBCO0lBQ2xJLElBQUk7UUFDQSxNQUFNLFNBQVMsR0FBRztZQUNkLFNBQVMsRUFBRSxLQUFLO1lBQ2hCLEdBQUc7U0FDTixDQUFDO1FBRUYsTUFBTSxNQUFNLEdBQUc7WUFDWCxNQUFNLEVBQUUsU0FBUztTQUNwQixDQUFBO1FBRUQsTUFBTSxTQUFTLEdBQUcsQ0FBQyxNQUFNLEVBQUUsR0FBRyxRQUFRLENBQUMsQ0FBQTtRQUN2QyxNQUFNLElBQUksR0FBRyxNQUFNLEtBQUssQ0FBQyxTQUFTLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQyxDQUFBO1FBQ3RELE9BQU8sSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQ2xCO0lBQUMsT0FBTyxDQUFDLEVBQUU7UUFDUixPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQ2QsTUFBTSw0QkFBWSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQTtLQUNyQztBQUNMLENBQUM7QUFsQkQsd0NBa0JDO0FBRUQsaUJBQWlCO0FBQ1YsS0FBSyxVQUFVLFNBQVMsQ0FBSSxLQUErQixFQUFFLEdBQWMsRUFBRSxLQUFXLEVBQUUsSUFBVSxFQUFFLFdBQWtCLEVBQUU7SUFDN0gsSUFBSTtRQUNBLE1BQU0sU0FBUyxHQUFHO1lBQ2QsU0FBUyxFQUFFLEtBQUs7WUFDaEIsR0FBRyxLQUFLO1NBQ1gsQ0FBQTtRQUNELE1BQU0sTUFBTSxHQUFHO1lBQ1gsTUFBTSxFQUFFLFNBQVM7U0FDcEIsQ0FBQTtRQUVELElBQUksS0FBSyxHQUFHO1lBQ1IsS0FBSyxFQUFFO2dCQUNILEdBQUcsRUFBRSxDQUFDO2FBQ1Q7U0FDSixDQUFBO1FBQ0QsSUFBSSxJQUFJLEVBQUU7WUFDTixLQUFLLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQTtTQUNyQjtRQUVELE1BQU0sRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLEdBQUcsR0FBRyxDQUFDO1FBQzVCLE1BQU0sS0FBSyxHQUFHLE1BQU0sS0FBSyxDQUFDLGNBQWMsQ0FBQyxTQUFTLENBQUMsQ0FBQTtRQUNuRCxNQUFNLFNBQVMsR0FBRyxDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsR0FBRyxRQUFRLENBQUMsQ0FBQTtRQUM5QyxNQUFNLElBQUksR0FBRyxNQUFNLEtBQUs7YUFDbkIsU0FBUyxDQUFDLFNBQVMsQ0FBQzthQUNwQixJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDO2FBQ3hCLEtBQUssQ0FBQyxLQUFLLENBQUM7YUFDWixPQUFPLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxFQUFFLFNBQVMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFBO1FBRXRDLE9BQU87WUFDSCxLQUFLO1lBQ0wsSUFBSTtTQUNQLENBQUE7S0FDSjtJQUFDLE9BQU8sQ0FBQyxFQUFFO1FBQ1IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUNkLE1BQU0sNEJBQVksQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUE7S0FDckM7QUFDTCxDQUFDO0FBcENELDhCQW9DQztBQUVELFFBQVE7QUFDRCxLQUFLLFVBQVUsS0FBSyxDQUFJLEtBQStCLEVBQUUsS0FBYTtJQUN6RSxJQUFJO1FBQ0EsTUFBTSxTQUFTLEdBQUc7WUFDZCxTQUFTLEVBQUUsS0FBSztZQUNoQixHQUFHLEtBQUs7U0FDWCxDQUFBO1FBQ0QsT0FBTyxNQUFNLEtBQUssQ0FBQyxjQUFjLENBQUMsU0FBUyxDQUFDLENBQUE7S0FDL0M7SUFBQyxPQUFPLENBQUMsRUFBRTtRQUNSLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDZixNQUFNLDRCQUFZLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFBO0tBQ3JDO0FBQ0wsQ0FBQztBQVhELHNCQVdDO0FBRUQsbUJBQW1CO0FBQ1osS0FBSyxVQUFVLGFBQWEsQ0FBSSxLQUErQixFQUFFLEdBQVcsRUFBRSxJQUFJLEVBQUUsT0FBc0I7SUFDN0csSUFBSTtRQUNBLE9BQU8sTUFBTSxLQUFLLENBQUMsU0FBUyxDQUFDLEVBQUUsR0FBRyxFQUFFLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0tBQ3hEO0lBQUMsT0FBTyxDQUFDLEVBQUU7UUFDUixPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2YsTUFBTSxDQUFDLENBQUE7S0FDVjtBQUNMLENBQUM7QUFQRCxzQ0FPQztBQUVELHNCQUFzQjtBQUNmLEtBQUssVUFBVSxnQkFBZ0IsQ0FBSSxLQUErQixFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsT0FBc0I7SUFDMUcsSUFBSTtRQUNBLE1BQU0sS0FBSyxDQUFDLGdCQUFnQixDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsRUFBRSxHQUFHLE9BQU8sRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUNyRSxPQUFNO0tBQ1Q7SUFBQyxPQUFPLENBQUMsRUFBRTtRQUNSLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDZixNQUFNLENBQUMsQ0FBQTtLQUNWO0FBQ0wsQ0FBQztBQVJELDRDQVFDO0FBRUQsdUJBQXVCO0FBQ2hCLEtBQUssVUFBVSxVQUFVLENBQUksS0FBK0IsRUFBRSxLQUFLLEVBQUUsSUFBWSxFQUFFLE9BQXNCO0lBRTVHLElBQUk7UUFDQSxNQUFNLEtBQUssQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztRQUM3QyxPQUFNO0tBQ1Q7SUFBQyxPQUFPLENBQUMsRUFBRTtRQUNSLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDZixNQUFNLDRCQUFZLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFBO0tBQ3JDO0FBQ0wsQ0FBQztBQVRELGdDQVNDO0FBRUQsU0FBUztBQUNGLEtBQUssVUFBVSxTQUFTLENBQUksS0FBK0IsRUFBRSxLQUFLO0lBQ3JFLElBQUk7UUFDQSxPQUFPLE1BQU0sS0FBSyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQTtLQUN0QztJQUFDLE9BQU8sQ0FBQyxFQUFFO1FBQ1IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUNkLE1BQU0sNEJBQVksQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUE7S0FDckM7QUFDTCxDQUFDO0FBUEQsOEJBT0M7QUFFRCx1QkFBdUI7QUFDaEIsS0FBSyxVQUFVLE1BQU0sQ0FBSSxLQUErQixFQUFFLEtBQUssR0FBRyxFQUFFLEVBQUUsT0FBTyxHQUFHLEVBQUU7SUFDckYsSUFBSTtRQUNBLE1BQU0sS0FBSyxHQUFHLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxHQUFHLEtBQUssRUFBRSxDQUFBO1FBQzVDLE1BQU0sVUFBVSxHQUFHLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRSxTQUFTLEVBQUUsQ0FBQyxFQUFFLEdBQUcsT0FBTyxFQUFFLENBQUE7UUFDdkQsT0FBTyxNQUFNLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLFVBQVUsQ0FBQyxDQUFBO0tBQzdDO0lBQUMsT0FBTyxDQUFDLEVBQUU7UUFDUixPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQ2QsTUFBTSw0QkFBWSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQTtLQUNyQztBQUNMLENBQUM7QUFURCx3QkFTQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJlQW5PYmplY3QsIE1vZGVsVHlwZSB9IGZyb20gXCJAdHlwZWdvb3NlL3R5cGVnb29zZS9saWIvdHlwZXNcIjtcbmltcG9ydCBtb25nb29zZSwgeyBBZ2dyZWdhdGVPcHRpb25zLCBRdWVyeU9wdGlvbnMsIFNhdmVPcHRpb25zIH0gZnJvbSBcIm1vbmdvb3NlXCI7XG5pbXBvcnQgeyBQYWdpbmdEdG8gfSBmcm9tIFwiLi4vdmFsaWRhdGlvbi9kdG8vcGFnaW5nLmR0b1wiO1xuaW1wb3J0IHsgQmFzZVJlc3BvbnNlIH0gZnJvbSBcIi4uL2Vycm9yL2Jhc2UucmVzcG9uc2VcIjtcblxuXG4vLy9UUkFOU0FDVElPTlxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHdpdGhUcmFuc2FjdGlvbihjYWxsYmFjaykge1xuICAgIHRyeSB7XG4gICAgICAgIGxldCByZXN1bHQ7XG4gICAgICAgIGNvbnN0IHNlc3Npb24gPSBhd2FpdCBtb25nb29zZS5zdGFydFNlc3Npb24oKTtcblxuICAgICAgICBhd2FpdCBzZXNzaW9uLndpdGhUcmFuc2FjdGlvbihhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICByZXN1bHQgPSBhd2FpdCBjYWxsYmFjayhzZXNzaW9uKVxuICAgICAgICB9KVxuXG4gICAgICAgIGF3YWl0IHNlc3Npb24uZW5kU2Vzc2lvbigpO1xuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cbiAgICBjYXRjaCAoZSkge1xuICAgICAgICBjb25zb2xlLmxvZyhlKVxuICAgICAgICB0aHJvdyBCYXNlUmVzcG9uc2UuVW5rbm93bkVycm9yKGUpXG4gICAgfVxufVxuXG4vLy9BR0dSRUdBVEVcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBhZ2dyZWdhdGU8VD4obW9kZWw6IE1vZGVsVHlwZTxULCBCZUFuT2JqZWN0PiwgcGlwZWxpbmU6IGFueSkge1xuICAgIHRyeSB7XG4gICAgICAgIHJldHVybiBhd2FpdCBtb2RlbC5hZ2dyZWdhdGUocGlwZWxpbmUpXG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBjb25zb2xlLmxvZyhlKVxuICAgICAgICB0aHJvdyBCYXNlUmVzcG9uc2UuVW5rbm93bkVycm9yKGUpXG4gICAgfVxufVxuXG4vLy9DUkVBVEVcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjcmVhdGU8VD4obW9kZWw6IE1vZGVsVHlwZTxULCBCZUFuT2JqZWN0PiwgZGF0YSwgb3B0aW9ucz86IFNhdmVPcHRpb25zKSB7XG4gICAgdHJ5IHtcbiAgICAgICAgcmV0dXJuIChhd2FpdCBtb2RlbC5jcmVhdGUoW2RhdGFdLCBvcHRpb25zKSkuc2hpZnQoKTsvL3NodSBqb3lkYSBzaGlmdCByZXR1cm4geW9xIGVkXG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBjb25zb2xlLmxvZyhlKVxuICAgICAgICB0aHJvdyBlXG4gICAgfVxufVxuXG4vLy9GSU5EIEJZIElEXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZmluZEJ5SWQ8VD4obW9kZWw6IE1vZGVsVHlwZTxULCBCZUFuT2JqZWN0PiwgX2lkOiBzdHJpbmcsIHByb2plY3QgPSB7fSwgb3B0aW9ucz86IFF1ZXJ5T3B0aW9ucykge1xuICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHF1ZXJ5ID0geyBfaWQsIGlzRGVsZXRlZDogZmFsc2UgfTtcbiAgICAgICAgY29uc3QgcHJvamVjdGlvbiA9IHsgX192OiAwLCBpc0RlbGV0ZWQ6IDAsIC4uLnByb2plY3QgfVxuICAgICAgICByZXR1cm4gYXdhaXQgbW9kZWwuZmluZE9uZShxdWVyeSwgcHJvamVjdGlvbiwgb3B0aW9ucylcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGUpXG4gICAgICAgIHRocm93IEJhc2VSZXNwb25zZS5Vbmtub3duRXJyb3IoZSlcbiAgICB9XG59XG5cbi8vL0ZJTkQgQlkgUVVFUllcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBmaW5kQnlRdWVyeTxUPihtb2RlbDogTW9kZWxUeXBlPFQsIEJlQW5PYmplY3Q+LCBxdWVyeSwgcHJvamVjdCA9IHt9LCBvcHRpb25zPzogUXVlcnlPcHRpb25zKSB7XG4gICAgdHJ5IHtcbiAgICAgICAgY29uc3QgcHJvamVjdGlvbiA9IHsgX192OiAwLCBpc0RlbGV0ZWQ6IDAsIC4uLnByb2plY3QgfVxuICAgICAgICByZXR1cm4gYXdhaXQgbW9kZWwuZmluZE9uZShxdWVyeSwgcHJvamVjdGlvbiwgb3B0aW9ucylcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGUpXG4gICAgICAgIHRocm93IEJhc2VSZXNwb25zZS5Vbmtub3duRXJyb3IoZSlcbiAgICB9XG59XG5cbi8vL0ZJTkQgQlkgUElQRUxJTkVcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBmaW5kQnlQaXBlbGluZTxUPihtb2RlbDogTW9kZWxUeXBlPFQsIEJlQW5PYmplY3Q+LCBfaWQ6IHN0cmluZywgcGlwZWxpbmU6IGFueVtdID0gW10sIG9wdGlvbnM/OiBBZ2dyZWdhdGVPcHRpb25zKSB7XG4gICAgdHJ5IHtcbiAgICAgICAgY29uc3QgYmFzZVF1ZXJ5ID0ge1xuICAgICAgICAgICAgaXNEZWxldGVkOiBmYWxzZSxcbiAgICAgICAgICAgIF9pZCxcbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCAkbWF0Y2ggPSB7XG4gICAgICAgICAgICAkbWF0Y2g6IGJhc2VRdWVyeVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgJHBpcGVsaW5lID0gWyRtYXRjaCwgLi4ucGlwZWxpbmVdXG4gICAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBtb2RlbC5hZ2dyZWdhdGUoJHBpcGVsaW5lLCBvcHRpb25zKVxuICAgICAgICByZXR1cm4gZGF0YVswXTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGUpXG4gICAgICAgIHRocm93IEJhc2VSZXNwb25zZS5Vbmtub3duRXJyb3IoZSlcbiAgICB9XG59XG5cbi8vL0ZJTkQgQlkgUEFHSU5HXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0UGFnaW5nPFQ+KG1vZGVsOiBNb2RlbFR5cGU8VCwgQmVBbk9iamVjdD4sIGR0bzogUGFnaW5nRHRvLCBxdWVyeT86IGFueSwgc29ydD86IGFueSwgcGlwZWxpbmU6IGFueVtdID0gW10pIHtcbiAgICB0cnkge1xuICAgICAgICBjb25zdCBiYXNlUXVlcnkgPSB7XG4gICAgICAgICAgICBpc0RlbGV0ZWQ6IGZhbHNlLFxuICAgICAgICAgICAgLi4ucXVlcnlcbiAgICAgICAgfVxuICAgICAgICBjb25zdCAkbWF0Y2ggPSB7XG4gICAgICAgICAgICAkbWF0Y2g6IGJhc2VRdWVyeVxuICAgICAgICB9XG5cbiAgICAgICAgbGV0ICRzb3J0ID0ge1xuICAgICAgICAgICAgJHNvcnQ6IHtcbiAgICAgICAgICAgICAgICBfaWQ6IDFcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoc29ydCkge1xuICAgICAgICAgICAgJHNvcnQuJHNvcnQgPSBzb3J0XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCB7IHBhZ2UsIGxpbWl0IH0gPSBkdG87XG4gICAgICAgIGNvbnN0IHRvdGFsID0gYXdhaXQgbW9kZWwuY291bnREb2N1bWVudHMoYmFzZVF1ZXJ5KVxuICAgICAgICBjb25zdCAkcGlwZWxpbmUgPSBbJG1hdGNoLCAkc29ydCwgLi4ucGlwZWxpbmVdXG4gICAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBtb2RlbFxuICAgICAgICAgICAgLmFnZ3JlZ2F0ZSgkcGlwZWxpbmUpXG4gICAgICAgICAgICAuc2tpcChsaW1pdCAqIChwYWdlIC0gMSkpXG4gICAgICAgICAgICAubGltaXQobGltaXQpXG4gICAgICAgICAgICAucHJvamVjdCh7IF9fdjogMCwgaXNEZWxldGVkOiAwIH0pXG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHRvdGFsLFxuICAgICAgICAgICAgZGF0YVxuICAgICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBjb25zb2xlLmxvZyhlKVxuICAgICAgICB0aHJvdyBCYXNlUmVzcG9uc2UuVW5rbm93bkVycm9yKGUpXG4gICAgfVxufVxuXG4vLy9DT1VOVFxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNvdW50PFQ+KG1vZGVsOiBNb2RlbFR5cGU8VCwgQmVBbk9iamVjdD4sIHF1ZXJ5OiBPYmplY3QpIHtcbiAgICB0cnkge1xuICAgICAgICBjb25zdCBiYXNlUXVlcnkgPSB7XG4gICAgICAgICAgICBpc0RlbGV0ZWQ6IGZhbHNlLFxuICAgICAgICAgICAgLi4ucXVlcnksXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGF3YWl0IG1vZGVsLmNvdW50RG9jdW1lbnRzKGJhc2VRdWVyeSlcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGUpO1xuICAgICAgICB0aHJvdyBCYXNlUmVzcG9uc2UuVW5rbm93bkVycm9yKGUpXG4gICAgfVxufVxuXG4vLy9VUERBVEUgT05FIEJZIElEXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdXBkYXRlT25lQnlJZDxUPihtb2RlbDogTW9kZWxUeXBlPFQsIEJlQW5PYmplY3Q+LCBfaWQ6IHN0cmluZywgZGF0YSwgb3B0aW9ucz86IFF1ZXJ5T3B0aW9ucykge1xuICAgIHRyeSB7XG4gICAgICAgIHJldHVybiBhd2FpdCBtb2RlbC51cGRhdGVPbmUoeyBfaWQgfSwgZGF0YSwgb3B0aW9ucyk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBjb25zb2xlLmxvZyhlKTtcbiAgICAgICAgdGhyb3cgZVxuICAgIH1cbn1cblxuLy8vVVBEQVRFIE9ORSBCWSBRVUVSWVxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHVwZGF0ZU9uZUJ5UXVlcnk8VD4obW9kZWw6IE1vZGVsVHlwZTxULCBCZUFuT2JqZWN0PiwgcXVlcnksIGRhdGEsIG9wdGlvbnM/OiBRdWVyeU9wdGlvbnMpIHtcbiAgICB0cnkge1xuICAgICAgICBhd2FpdCBtb2RlbC5maW5kT25lQW5kVXBkYXRlKHF1ZXJ5LCBkYXRhLCB7IC4uLm9wdGlvbnMsIG5ldzogdHJ1ZSB9KTtcbiAgICAgICAgcmV0dXJuXG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBjb25zb2xlLmxvZyhlKTtcbiAgICAgICAgdGhyb3cgZVxuICAgIH1cbn1cblxuLy8vVVBEQVRFIE1BTlkgQlkgUVVFUllcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB1cGRhdGVNYW55PFQ+KG1vZGVsOiBNb2RlbFR5cGU8VCwgQmVBbk9iamVjdD4sIHF1ZXJ5LCBkYXRhOiBvYmplY3QsIG9wdGlvbnM/OiBRdWVyeU9wdGlvbnNcbikge1xuICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IG1vZGVsLnVwZGF0ZU1hbnkocXVlcnksIGRhdGEsIG9wdGlvbnMpO1xuICAgICAgICByZXR1cm5cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGUpO1xuICAgICAgICB0aHJvdyBCYXNlUmVzcG9uc2UuVW5rbm93bkVycm9yKGUpXG4gICAgfVxufVxuXG4vLy9ERUxFVEVcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBkZWxldGVPbmU8VD4obW9kZWw6IE1vZGVsVHlwZTxULCBCZUFuT2JqZWN0PiwgcXVlcnkpIHtcbiAgICB0cnkge1xuICAgICAgICByZXR1cm4gYXdhaXQgbW9kZWwuZGVsZXRlT25lKHF1ZXJ5KVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgY29uc29sZS5sb2coZSlcbiAgICAgICAgdGhyb3cgQmFzZVJlc3BvbnNlLlVua25vd25FcnJvcihlKVxuICAgIH1cbn1cblxuLy8vR0VUIEFMTCAvKiBjdXN0b20gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRBbGw8VD4obW9kZWw6IE1vZGVsVHlwZTxULCBCZUFuT2JqZWN0PiwgcXVlcnkgPSB7fSwgcHJvamVjdCA9IHt9KSB7XG4gICAgdHJ5IHtcbiAgICAgICAgY29uc3QgUXVlcnkgPSB7IGlzRGVsZXRlZDogZmFsc2UsIC4uLnF1ZXJ5IH1cbiAgICAgICAgY29uc3QgcHJvamVjdGlvbiA9IHsgX192OiAwLCBpc0RlbGV0ZWQ6IDAsIC4uLnByb2plY3QgfVxuICAgICAgICByZXR1cm4gYXdhaXQgbW9kZWwuZmluZChRdWVyeSwgcHJvamVjdGlvbilcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGUpXG4gICAgICAgIHRocm93IEJhc2VSZXNwb25zZS5Vbmtub3duRXJyb3IoZSlcbiAgICB9XG59XG4iXX0=